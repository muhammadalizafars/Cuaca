<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cuaca Cicaheum Realtime</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: sans-serif;
            background-color: #f2f7fb;
            margin: 30;
            padding: 30;
        }

        .cuaca-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 15px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .header {
            padding: 20px;
            border-radius: 12px;
            color: white;
            text-align: left;
        }

        .suhu {
            font-size: 48px;
            font-weight: bold;
        }

        .ikon-cuaca {
            width: 80px;
            margin: 10px auto;
        }

        .info-kecil {
            text-align: right;
            font-size: 12px;
            color: #666;
        }

        .info {
            display: flex;
            flex-wrap: wrap;
            overflow-x: auto;
            gap: 20px;
        }

        .info-lengkap {
            background-color: #eef3f7;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            line-height: 1.6em;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .prakiraan {
            margin-top: 20px;
            overflow-x: auto;
        }

        .jam-container {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding: 10px 0;
        }

        .jam-box {
            background: #e0f0fb;
            border-radius: 12px;
            padding: 10px;
            min-width: 120px;
            text-align: center;
            box-shadow: 0 0 5px #ccc;
            flex-shrink: 0;
        }

        .grafik-maps-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
            justify-content: center;
        }

        .data,
        .maps {
            flex: 1;
            min-width: 200px;
        }

        iframe {
            width: 100%;
            height: 300px;
            border: 0;
            border-radius: 12px;
        }
    </style>
</head>

<body>
    <div class="cuaca-container">
        <div class="info-kecil">
            <p id="waktu-update">UPDATE: --</p>
        </div>
        <div class="header" id="header-bg">
            <h1>CUACA SAAT INI</h1>
            <img id="ikon-cuaca" src="" alt="Icon Cuaca" class="ikon-cuaca" />
            <h2 id="cuaca-sekarang">Memuat...</h2>
            <div class="suhu" id="suhu-sekarang">--¬∞C</div>
            <h2 id="lokasi">di ...</h2>
        </div>

        <div class="info">
            <div class="info-lengkap">
                <p id="kelembapan">Kelembapan: --%</p>
            </div>
            <div class="info-lengkap">
                <p id="angin">Kecepatan Angin: -- km/jam</p>
            </div>
            <div class="info-lengkap">
                <p id="arah-angin">Arah Angin dari: --</p>
            </div>
            <div class="info-lengkap">
                <p id="jarak-pandang">Jarak Pandang: --</p>
            </div>
        </div>

        <div class="prakiraan">
            <div class="jam-container" id="jam-container">
                <p>Memuat data prakiraan...</p>
            </div>
        </div>

        <h3 style="text-align: center">Grafik Suhu & Peta Lokasi</h3>
        <div class="grafik-maps-container">
            <div class="maps">
                <iframe src="https://www.google.com/maps?q=-6.922222,107.6425&hl=id&z=14&output=embed" allowfullscreen>
                </iframe>
            </div>
            <div class="data">
                <canvas id="grafik-suhu" height="300"></canvas>
            </div>
        </div>
    </div>

    <script>
        async function fetchCuaca() {
            try {
                const response = await fetch("https://api.bmkg.go.id/publik/prakiraan-cuaca?adm4=32.73.16.1004");
                const result = await response.json();

                const lokasi = result.data[0].lokasi;
                const cuacaList = result.data[0].cuaca[0];
                const now = new Date();
                const nowHour = now.getHours();

                const arahMataAngin = {
                    N: "Utara", NE: "Timur Laut", E: "Timur", SE: "Tenggara",
                    S: "Selatan", SW: "Barat Daya", W: "Barat", NW: "Barat Laut"
                };

                const cuacaSekarang = cuacaList.find(item => new Date(item.local_datetime).getHours() === nowHour) || cuacaList[0];

                document.getElementById("cuaca-sekarang").textContent = cuacaSekarang.weather_desc;
                document.getElementById("suhu-sekarang").textContent = cuacaSekarang.t + "¬∞C";
                document.getElementById("waktu-update").textContent =
                    "UPDATE: " + new Date(cuacaSekarang.local_datetime).toLocaleString("id-ID", { timeZone: "Asia/Jakarta" });

                document.getElementById("kelembapan").textContent = "üå´Ô∏è Kelembapan: " + cuacaSekarang.hu + "%";
                document.getElementById("angin").textContent = "üå¨Ô∏è Kecepatan Angin: " + cuacaSekarang.ws + " km/jam";
                document.getElementById("arah-angin").textContent = "üåç Arah Angin dari: " + (arahMataAngin[cuacaSekarang.wd] || cuacaSekarang.wd);
                document.getElementById("jarak-pandang").textContent = "üëÅÔ∏è Jarak Pandang: " + cuacaSekarang.vs_text;
                document.getElementById("lokasi").textContent = `DI ${lokasi.desa.toUpperCase()}, ${lokasi.kecamatan.toUpperCase()}, ${lokasi.kotkab.toUpperCase()}`;

                document.getElementById("ikon-cuaca").src = cuacaSekarang.image;
                document.getElementById("ikon-cuaca").alt = cuacaSekarang.weather_desc;

                const header = document.getElementById("header-bg");
                const desc = cuacaSekarang.weather_desc.toLowerCase();
                if (desc.includes("hujan")) header.style.backgroundColor = "#607d8b";
                else if (desc.includes("cerah")) header.style.backgroundColor = "#4da6ff";
                else header.style.backgroundColor = "#90caf9";

                const container = document.getElementById("jam-container");
                container.innerHTML = "";
                const dataGrafik = { labels: [], suhu: [] };

                // Interpolasi antar data 3-jam jadi 1-jam
                const interpolated = [];
                for (let i = 0; i < cuacaList.length - 1; i++) {
                    const curr = cuacaList[i];
                    const next = cuacaList[i + 1];

                    const currDate = new Date(curr.local_datetime);
                    interpolated.push({
                        waktu: currDate,
                        t: curr.t,
                        desc: curr.weather_desc,
                        image: curr.image
                    });

                    for (let j = 1; j < 3; j++) {
                        const interTime = new Date(currDate.getTime() + j * 3600000);
                        interpolated.push({
                            waktu: interTime,
                            t: Math.round((curr.t * (3 - j) + next.t * j) / 3),
                            desc: curr.weather_desc,
                            image: curr.image
                        });
                    }
                }

                // Tambahkan data terakhir
                const last = cuacaList[cuacaList.length - 1];
                interpolated.push({
                    waktu: new Date(last.local_datetime),
                    t: last.t,
                    desc: last.weather_desc,
                    image: last.image
                });

                interpolated.slice(0, 12).forEach(item => {
                    const waktu = item.waktu.toLocaleTimeString("id-ID", {
                        hour: "2-digit", minute: "2-digit", hour12: false
                    });

                    const box = document.createElement("div");
                    box.className = "jam-box";
                    box.innerHTML = `
            <p><strong>${waktu} WIB</strong></p>
            <img src="${item.image}" alt="${item.desc}" width="50">
            <p>${item.desc}</p>
            <p>${item.t}¬∞C</p>
          `;
                    container.appendChild(box);

                    dataGrafik.labels.push(waktu);
                    dataGrafik.suhu.push(item.t);
                });

                new Chart(document.getElementById("grafik-suhu"), {
                    type: "line",
                    data: {
                        labels: dataGrafik.labels,
                        datasets: [{
                            label: "Suhu (¬∞C)",
                            data: dataGrafik.suhu,
                            borderColor: "#42a5f5",
                            backgroundColor: "rgba(66,165,245,0.2)",
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: true } },
                        scales: { y: { beginAtZero: false } }
                    }
                });

            } catch (error) {
                console.error("Gagal memuat data cuaca:", error);
                document.getElementById("jam-container").innerHTML = "<p>Gagal memuat data.</p>";
            }
        }

        fetchCuaca();
    </script>
</body>

</html>